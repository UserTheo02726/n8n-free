name: Check for n8n Updates and Sync to Hugging Face Space

on:
  schedule:
    - cron: '0 18 * * 5' # Every Friday at 18:00 UTC (02:00 Saturday CST)
  workflow_dispatch:     # Allow manual trigger for testing

permissions:
  contents: write # Required write permission to modify Dockerfile

jobs:
  update-version:
    runs-on: ubuntu-latest
    outputs:
      changes_detected: ${{ steps.auto_commit.outputs.changes_detected }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get Latest n8n Version
        id: get_version
        run: |
          echo "æ­£åœ¨æ‹‰å– blowsnow/n8n-chinese:latest è·å–çœŸå®ç‰ˆæœ¬å·..."
          
          # 1. æ‹‰å–é•œåƒ
          docker pull blowsnow/n8n-chinese:latest
          
          # 2. è¿è¡Œå¹¶è¯¢é—®ç‰ˆæœ¬ (è¾“å‡ºä¾‹å¦‚: 2.11.2)
          VERSION=$(docker run --rm --entrypoint="" blowsnow/n8n-chinese:latest n8n --version)
          
          # 3. æ¸…ç†ä¸€ä¸‹è¾“å‡º (é˜²æ­¢æœ‰æ¢è¡Œç¬¦)
          VERSION=$(echo "$VERSION" | tr -d '\r\n')
          
          echo "âœ… è·å–åˆ°æœ€æ–°ç‰ˆæœ¬: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update Dockerfile
        run: |
          NEW_VER="${{ steps.get_version.outputs.version }}"
          
          if [ -z "$NEW_VER" ]; then
             echo "âŒ è·å–ç‰ˆæœ¬å¤±è´¥ï¼Œè„šæœ¬åœæ­¢"
             exit 1
          fi

          echo "æ­£åœ¨å°† Dockerfile æ›´æ–°è‡³ç‰ˆæœ¬: $NEW_VER"

          # 1. æ›¿æ¢ FROM è¡Œ (æ”¯æŒæ›¿æ¢ latest æˆ– æ—§ç‰ˆæœ¬å·)
          sed -i -E "s/blowsnow\/n8n-chinese:[a-zA-Z0-9.-]+/blowsnow\/n8n-chinese:$NEW_VER/g" Dockerfile

          # 2. æ›¿æ¢ RUN npm install è¡Œ (æ”¯æŒæ›¿æ¢ latest æˆ– æ—§ç‰ˆæœ¬å·)
          sed -i -E "s/n8n@[a-zA-Z0-9.-]+/n8n@$NEW_VER/g" Dockerfile
          
          echo "ğŸ” ä¿®æ”¹åçš„æ–‡ä»¶å†…å®¹æ£€æŸ¥:"
          grep -E "blowsnow|npm install" Dockerfile

      - name: Auto Commit
        id: auto_commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update n8n to version ${{ steps.get_version.outputs.version }}"
          file_pattern: Dockerfile
          push_options: '--force'

  trigger-sync:
    needs: update-version
    if: needs.update-version.outputs.changes_detected == 'true'
    uses: ./.github/workflows/push-to-huggingface.yml
    secrets: inherit

  reboot-space:
    needs: trigger-sync
    runs-on: ubuntu-latest
    steps:
      - name: Restart Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_REPO: ${{ vars.HF_REPO }}
        run: |
          if [ -z "$HF_REPO" ]; then
            echo "::error::HF_REPO is not set"
            exit 1
          fi
          echo "Triggering Factory Reboot for $HF_REPO..."
          curl -X POST "https://huggingface.co/api/spaces/$HF_REPO/restart?factory=true" \
               -H "Authorization: Bearer $HF_TOKEN" \
               -v
