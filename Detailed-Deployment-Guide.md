# n8n Free Deployment Guide (Supabase + Hugging Face)

Automatically deploy n8n to ü§ó Hugging Face Space using üê± GitHub Actions, with üå©Ô∏è Supabase as the database.

## 1. Preparation

*   **üê± GitHub**

*   **üå©Ô∏è Supabase**

*   **ü§ó Hugging Face**


---

## 2. Information Usage Example

Collect and store these details securely. You will need them for the setup.

*   üå©Ô∏è **Supabase Details**
    *   **Project Name**: `n8n-db`
    *   **Database Password**: `(Hidden)` ‚Äî **Save immediately** upon creation.
    *   **Host**: `aws-1-ap-southeast-1.pooler.supabase.com` ‚Äî Use **Transaction Pooler**.
    *   **Port**: `6543`
    *   **Database**: `postgres`
    *   **User**: `postgres.AAAA...` (Long string from Transaction Pooler)
    *   **Connection String**: `postgres://[user]:[pwd]@[host]:[port]/[db]`
    *   **Project URL**: `https://AAAA...supabase.co`
    *   **Publishable Key**: `AAAA...` (`anon` key)
    *   **SSL Certificate**: Download `.crt`, open in text editor, copy **everything**.

*   ü§ó **Hugging Face Details**
    *   **Space**: `username/n8n-server`
    *   **Description**: `n8n hosted with supabase`
    *   **Access Token**: `hf_AAAA...` (Create with **Write** permissions)

---

## 3. üå©Ô∏è Supabase Database Configuration

### Create Project
1.  **New Project**.
2.  Generate **Database Password** and save it securely; it cannot be viewed later.
3.  Wait for the project initialization to complete.

### Initialize Table Structure
1.  Go to the **SQL Editor** on the left.
2.  Paste and run the following SQL (for keep-alive):
    ```sql
    CREATE TABLE "keep-alive" (
      id BIGINT generated BY DEFAULT AS IDENTITY,
      name text NULL,
      created_at timestamptz DEFAULT now(),
      CONSTRAINT "keep-alive_pkey" PRIMARY KEY (id)
    );
    INSERT INTO "keep-alive"(name) VALUES ('ping');
    ```
    *Note: If a red warning appears, ignore it. It will not affect database operation or n8n usage. You can safely proceed.*

### Get Connection Information
1.  Click the green **Connect** button at the top.
2.  Select **Transaction Pooler** (Recommended) or Direct connection.
3.  Copy the connection string for later use, formatted as follows:
    `postgres://[db-user]:[db-password]@[host]:[port]/[db-name]`
    *   **Host**: The domain after `@` (e.g., `aws-0-us-west-1.pooler.supabase.com`)
    *   **Port**: The port after the domain (usually `6543` or `5432`)
    *   **User**: The username after `postgres://` (Note: Usernames in Transaction Pooler mode can be very long)

---

## 4. ü§ó Hugging Face Space Configuration

1.  Login to ü§ó Hugging Face.
    *   **Create New Space**.
    *   **Space Name**: Custom, e.g., `n8n-server`.
    *   **Description**: Custom, e.g., `n8n free hosted with supabase`.
    *   **License**: Select `MIT` (or any other license you prefer).
    *   **SDK**: Select `Docker` (Required).
    *   **Hardware**: Select `Free`.
2.  Go to the **Settings** page of the Space to configure environment variables.

### Configure Environment Variables: Secrets (Sensitive Information)

| Key | Value Description | How to Obtain |
| :--- | :--- | :--- |
| `DB_POSTGRESDB_HOST` | Database Host | Supabase Panel -> **Connect** -> **Transaction Pooler** -> Domain after `@` in URI |
| `DB_POSTGRESDB_PORT` | Port | Same as above, port after domain (usually 6543) |
| `DB_POSTGRESDB_DATABASE` | `postgres` | Fixed value (unless you changed the database name) |
| `DB_POSTGRESDB_USER` | Database Username | (user field) |
| `DB_POSTGRESDB_PASSWORD` | Database Password | Password set when creating the Supabase project (Reset in Project Settings -> Database -> Reset password if forgotten) |
| `DB_POSTGRESDB_SSL_CA` | Full SSL Certificate Content | **Must enable "Enforce SSL" in Supabase** -> Download certificate -> Open `prod-ca-2021.crt` with text editor -> Copy all content. Enter "none" if not using a certificate. |
| `N8N_ENCRYPTION_KEY` | Random String | Make one up, e.g., `my-n8n-secret-key-123` (Keep it stable) |

### Configure Environment Variables: Variables (Public Variables)

| Key | Value | Description |
| :--- | :--- | :--- |
| `N8N_DATABASE_SSL_REJECT_UNAUTHORIZED` | `true` | **Fill `true` if using certificate (DB_POSTGRESDB_SSL_CA); must fill `false` if no certificate (none)** |
| `DB_TYPE` | `postgresdb` | **Note: Must be `postgresdb`. Using `postgres` will cause data loss!** |
| `DB_POSTGRESDB_SCHEMA` | `public` | |
| `N8N_PORT` | `7860` | |
| `N8N_PROTOCOL` | `https` | |
| `N8N_HOST` | `<username>-<spacename>.hf.space` | |
| `N8N_EDITOR_BASE_URL` | `https://<username>-<spacename>.hf.space` | |
| `WEBHOOK_URL` | `https://<username>-<spacename>.hf.space` | |
| `N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS` | `true` | |
| `N8N_PUSH_BACKEND` | `websocket` | |
| `N8N_PROXY_HOPS` | `1` | **Required**, corrects proxy levels |
| `EXECUTIONS_DATA_PRUNE` | `true` | Enable auto-cleanup (Recommended) |
| `EXECUTIONS_DATA_MAX_AGE` | `168` | Keep data for 7 days (Recommended) |
| `EXECUTIONS_DATA_SAVE_ON_SUCCESS` | `none` | Do not save on success (Recommended) |
| `EXECUTIONS_DATA_SAVE_ON_ERROR` | `all` | Save all on error (Recommended) |
| `GENERIC_TIMEZONE` | `Asia/Shanghai` | n8n Timezone (Optional) |
| `TZ` | `Asia/Shanghai` | Container Timezone (Optional) |
| `N8N_REINSTALL_MISSING_PACKAGES` | `true` | Automatically reinstall missing nodes (Recommended) |

> **Tip**: If addresses like `N8N_HOST` are uncertain, fill in a placeholder format and modify it after the Space is created.

### Required Information:

1.  **Space**: username/spacename (e.g., `supertheovo/n8n-server`)
2.  **Description**: n8n free hosted with supabase
3.  **Access Tokens**: Used for "üê± GitHub Actions `HF_TOKEN` configuration". Set in Hugging Face Access Tokens (Requires Write permission).

---

## 5. üê± GitHub Actions Configuration

Return to your GitHub Fork repository, go to **Settings > Secrets and variables > Actions**.

### Repository Secrets
Click **New repository secret** at the top right and add the following 3 secrets:

| Secret Name | Value Description | Acquisition Path |
| :--- | :--- | :--- |
| `HF_TOKEN` | Hugging Face Access Token<br>*(Note: Must check `Write` permission)* | **HF Avatar** > Settings > Access Tokens > New token > Role: Write |
| `SUPABASE_URL` | Supabase **project URL** | **Project Settings** (Gear icon) > **API** > Project URL |
| `SUPABASE_KEY` | Supabase **Publishable Key** (`anon`) | **Project Settings** (Gear icon) > **API** > Publishable key (`anon`/`public`) |

### Repository Variables
Click **New repository variable** at the top right and add the following 1 variable:

| Variable Name | Value Example | Description |
| :--- | :--- | :--- |
| `HF_REPO` | `username/space-name` | **Your** Hugging Face Space repository path<br>*(e.g., `supertheovo/n8n-server`)* |

---

## 6. Enable Scheduled Automation (Important)

| File (`.yml`) | Trigger | Core Action | Purpose |
| :--- | :--- | :--- | :--- |
| **push-to-huggingface** | **On Push**<br>(Push to main) | `git push --force` to HF | **Sync Code**<br>Instantly deploy GitHub changes to Hugging Face Space. |
| **healthcheck** | **Every 10 mins**<br>(Cron: `*/10`) | Run `healthcheck-rebuild.sh` | **Self-healing**<br>High-frequency service status check. **Note:** Depends on `.sh` script in root. |
| **huggingface-keep-alive** | **Daily 03:00 UTC**<br>(11:00 Beijing) | `curl` Space URL | **Space Keep-alive**<br>Simulate traffic to prevent Space sleep after 48h inactivity. |
| **supabase-keep-alive** | **Daily 03:00 UTC**<br>(11:00 Beijing) | `curl` Supabase API | **Database Keep-alive**<br>Prevent free Supabase DB pause after inactivity (usually 7 days). |
| **update-n8n** | **Fri 18:00 UTC**<br>(Sat 02:00 Beijing) | API call `restart?factory=true` | **Software Update**<br>Force "Factory Reboot" to pull the latest Docker image. |

By default, scheduled triggers are commented out to prevent errors during setup. It is recommended to **manually enable** them for stable operation.

Please edit the following 3 files in the GitHub repository:
1.  `.github/workflows/update-n8n.yml` (**Auto update n8n**)
2.  `.github/workflows/huggingface-keep-alive.yml` (ü§ó Hugging Face Space Keep-alive)
3.  `.github/workflows/supabase-keep-alive.yml` (üå©Ô∏è Supabase Database Keep-alive)

Uncomment the `schedule` section by removing the `#` at the beginning of the lines.

**Note**: `update-n8n.yml` has been modified to "Restart Space weekly". Since the Chinese image uses the `latest` tag, restarting the Space will automatically pull the latest Chinese image.

**Before**:
```yaml
on:
  # schedule:
  #   - cron: '0 3 * * *'
  workflow_dispatch:
```

**After**:
```yaml
on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
```

---

## 7. Start Deployment

1.  After committing changes (modifying Dockerfile, etc.) to GitHub, Actions will automatically trigger the `Push to huggingface` workflow.
2.  Go to the **Actions** tab in GitHub to check if `Push to huggingface` is running (green rotating icon).
3.  If not running, manually trigger it:
    *   Select **Push to huggingface** workflow.
    *   Click **Run workflow**.

Wait a few minutes. After GitHub Actions completes, Hugging Face Space will start building. Once built (Status: Running), your n8n is ready.

---

## 8. n8n Access Address

üîó **https://<username>-<spacename>.hf.space**

---

## 9. Set up Workflow (Optional Keep-alive)

This workflow triggers GitHub Actions from within n8n as a dual keep-alive mechanism. If you enabled GitHub scheduled tasks (Step 5), this is optional.

1.  **Import Workflow**:
    *   Copy content from `Auto keep n8n alive and updates on n8n-free repo.json` in the project root.
    *   In n8n canvas, Menu -> Import from File/URL or paste directly.

2.  **Configure Nodes**:
    Imported nodes need configuration (default is author's info):
    *   **Double click each GitHub node** and modify:
        *   **Credential**: Create new üê± GitHub API credential (using Personal Access Token).
            *   **Get Token**: üê± GitHub -> Settings -> Developer settings -> Personal access tokens -> Tokens (classic) -> Generate new token.
            *   **Permissions**: Check `repo` (Full control of private repositories) and `workflow` (Update GitHub Action workflows).
        *   **Owner**: Your üê± GitHub username.
        *   **Repository**: Your Forked repository name (e.g., `n8n-server`).
        *   **Workflow ID**: After modifying Owner and Repository, re-select the corresponding YAML file:
            *   Node 1: `huggingface-keep-alive.yml`
            *   Node 2: `supabase-keep-alive.yml`
            *   Node 3: `update-n8n.yml`

---

## 10. Maintenance

*   **Auto Update**: Scheduled tasks automatically check and update n8n.
*   **Keep-alive**: `healthcheck.yml` regularly checks status and restarts Space if down.

---

## 11. About Chinese Version n8n (Skip if not needed)

This guide supports deploying the Chinese version of n8n. Follow these steps:

1.  ü§ó **Hugging Face Space Configuration**:
    *   **Settings** -> **Variables**.
    *   Add Variable: **Key**: `N8N_DEFAULT_LOCALE` **Value**: `zh-CN`

2.  üê± **Modify GitHub Files**:
    *   **Dockerfile**: Modify to use Chinese image (See [Modified File List](#2-modified-file-list-copy-paste-ready)).
    *   **update-n8n.yml**: Modify for weekly restart (See [Modified File List](#2-modified-file-list-copy-paste-ready)).
    *   **Other files**: Keep `.github/workflows/huggingface-keep-alive.yml` and `.github/workflows/supabase-keep-alive.yml` as is (just ensure uncommented).

3.  üöÄ **Commit and Push**:
    *   Commit changes.
    *   GitHub Actions triggers `Push to huggingface`.
    *   Wait for build completion.

### 2. Modified File List (Copy-Paste Ready)

Ensure your deployment is smooth by copying the following code:

#### (1) `Dockerfile`
Specifies the Chinese image.

```dockerfile
FROM blowsnow/n8n-chinese:latest
USER node
```

#### (2) `.github/workflows/update-n8n.yml`
Restarts Space weekly to pull updates.

```yaml
name: Check for n8n Updates and Sync to Hugging Face Space

on:
  schedule:
    - cron: '0 18 * * 5' # Every Friday at 18:00 UTC
  workflow_dispatch:

jobs:
  rebuild-space:
    runs-on: ubuntu-latest
    steps:
      - name: Restart Hugging Face Space to pull latest image
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_REPO: ${{ vars.HF_REPO }}
        run: |
          if [ -z "$HF_REPO" ]; then
            echo "::error::HF_REPO is not set"
            exit 1
          fi
          echo "Triggering Factory Reboot for $HF_REPO to pull latest docker image..."
          # Factory reboot forces a complete rebuild of the container, pulling the latest layers
          curl -X POST "https://huggingface.co/api/spaces/$HF_REPO/restart?factory=true" \
               -H "Authorization: Bearer $HF_TOKEN" \
               -v
```

### 3. Manual Update?
Don't want to wait for Friday?
1.  Go to Hugging Face Space **Settings**.
2.  Click **Factory Reboot**.
3.  Done.

### 4. FAQ

#### Why change Docker image?
*   **Original**: Official English (`docker.n8n.io/n8nio/n8n`)
*   **Current**: Community Chinese (`blowsnow/n8n-chinese:latest`)
*   **Reason**: For Chinese language support.

#### Why did auto-update change?
*   **Before**: Watched official releases.
*   **Now**: **Weekly Space Restart**.
*   **Reason**:
    *   Community version updates lag behind official.
    *   Tag matching often fails.
    *   Weekly restart ensures `latest` image is pulled.

---

## 12. Troubleshooting

- **Healthcheck fails (missing HF_REPO)**: Set `HF_REPO` in GitHub Repository variables (`owner/space`).
- **Database SSL Error**: Enable SSL in Supabase and ensure `DB_POSTGRESDB_SSL_CA` has full PEM content.
- **Webhook wrong host**: Align `N8N_HOST`, `N8N_EDITOR_BASE_URL`, and `WEBHOOK_URL` to your Space address.

---

